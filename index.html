<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è‰²ç­†è¨˜ Pro - å…¨çƒæ——è‰¦æœ€çµ‚ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --palette-pink: #FF85A1;
            --palette-blue: #8EC5FC;
            --palette-orange: #FFA45B;
            --palette-purple: #E0C3FC;
            --palette-bg: #FFFDF0;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--palette-bg);
            color: #334155;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .float-btn { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(142, 197, 252, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(142, 197, 252, 0); }
            100% { box-shadow: 0 0 0 0 rgba(142, 197, 252, 0); }
        }

        .nav-active {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.15);
        }

        .folder-active {
            background-color: var(--palette-pink);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 133, 161, 0.3);
        }

        .btn-active:active { transform: scale(0.92); }
        
        .spot-card-gradient {
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
        }
    </style>
</head>
<body class="pb-36">

    <!-- æ¨™é¡Œè¦–è¦º -->
    <header class="pt-10 pb-6 text-center relative max-w-4xl mx-auto flex flex-col items-center px-4">
        <div class="relative inline-block">
            <h1 class="text-5xl md:text-6xl font-black text-[#FF85A1] tracking-tighter drop-shadow-sm italic">æ—…è‰²ç­†è¨˜</h1>
            <div class="absolute -right-4 -top-2 w-6 h-6 bg-[#FFD1A4] rounded-full opacity-60 animate-pulse"></div>
        </div>
        <p class="text-[10px] text-slate-400 font-bold tracking-[0.4em] mt-1 opacity-70 uppercase">Global peak Edition Pro</p>
        
        <button class="absolute right-6 top-10 w-11 h-11 bg-white rounded-2xl shadow-md flex items-center justify-center text-[#FF85A1] border border-slate-100 btn-active transition-transform">
            <i data-lucide="user-round" class="w-5 h-5"></i>
        </button>
    </header>

    <main id="main-content" class="px-5 md:px-8 max-w-4xl mx-auto">
        <div class="flex flex-col items-center justify-center py-32 text-slate-300">
            <div class="animate-spin mb-4 text-[#FF85A1]"><i data-lucide="loader-2" class="w-10 h-10"></i></div>
            <p class="font-black tracking-widest text-sm uppercase">æ­£åœ¨ç¢ºèªåœ°ç†ä½ç½®...</p>
        </div>
    </main>

    <!-- åœ°åœ–æ‡¸æµ®æ¨™ -->
    <button id="floating-map-btn" onclick="window.open('https://www.google.com/maps')" class="fixed bottom-28 right-6 w-14 h-14 bg-[#8EC5FC] text-white rounded-full shadow-2xl flex items-center justify-center z-40 border-4 border-white float-btn btn-active hidden">
        <i data-lucide="navigation" class="w-7 h-7" fill="currentColor"></i>
    </button>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[94%] max-w-lg glass rounded-[2.5rem] p-1.5 shadow-2xl flex justify-between items-center z-50 border border-white/50">
        <button onclick="switchTab('home')" id="nav-home" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all duration-300 flex-1 min-w-0 text-slate-400">
            <i data-lucide="compass" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">é¦–é </span>
        </button>
        <button onclick="switchTab('favorite')" id="nav-favorite" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all duration-300 flex-1 min-w-0 text-slate-400">
            <i data-lucide="heart" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">æ”¶è—</span>
        </button>
        <button onclick="switchTab('itinerary')" id="nav-itinerary" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all duration-300 flex-1 min-w-0 text-slate-400">
            <i data-lucide="map-pinned" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('calorie')" id="nav-calorie" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all duration-300 flex-1 min-w-0 text-slate-400">
            <i data-lucide="flame" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">ç†±é‡</span>
        </button>
        <button onclick="switchTab('journal')" id="nav-journal" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all duration-300 flex-1 min-w-0 text-slate-400">
            <i data-lucide="pen-tool" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">æ—¥è¨˜</span>
        </button>
        <button onclick="switchTab('checklist')" id="nav-checklist" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all duration-300 flex-1 min-w-0 text-slate-400">
            <i data-lucide="check-check" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">æ¸…å–®</span>
        </button>
    </nav>

    <!-- å±¤ç´šåŒ–åœ°å€é¸å–æŠ½å±œ -->
    <div id="region-picker" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-end justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-t-[3rem] p-8 shadow-2xl translate-y-full transition-transform duration-500 overflow-hidden relative border-t-4 border-[#FF85A1]/20">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex gap-2 mb-4">
                <div class="flex-1 relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="picker-search" oninput="handlePickerSearch(this.value)" class="w-full bg-slate-100 p-3 pl-11 rounded-2xl outline-none focus:ring-2 focus:ring-[#FF85A1]/20 font-bold text-sm" placeholder="å…¨åŸŸæœå°‹åŸå¸‚æˆ–åœ‹å®¶...">
                </div>
                <button onclick="detectLocation()" class="bg-[#8EC5FC] text-white p-3 rounded-2xl active:scale-90 transition-all">
                    <i data-lucide="locate-fixed" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="picker-content" class="max-h-[50vh] overflow-y-auto no-scrollbar"></div>
            <button onclick="closePicker()" class="w-full mt-6 py-4 bg-slate-100 rounded-2xl font-bold text-slate-400 active:scale-95 transition-all">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const safeGetConfig = () => {
            try { return window['__firebase_config'] ? JSON.parse(window['__firebase_config']) : null; }
            catch (e) { return null; }
        };

        const config = safeGetConfig();
        const appId = window['__app_id'] || 'travel-palette-global-v3';

        let db, auth;
        let currentUser = null;
        let activeTab = 'home';
        let isDemoMode = !config; 
        
        window.state = {
            calories: [], itineraries: [], journals: [], checklist: [], favorites: [],
            folders: ["é è¨­æ”¶è—"], activeFolder: "é è¨­æ”¶è—", activeItinTab: 'personal',
            activeRegion: 'å°åŒ—', activeCountry: 'å°ç£', selectedGuide: null, selectedSpot: null, showAdventure: true,
            pickerStep: 'continent', selectedContinent: null, selectedCountry: null, searchQuery: ''
        };

        const geoData = [
            { continent: "æ±äº", icon: "ğŸŒ", countries: [
                { name: "å°ç£", cities: ["å°åŒ—", "å°ä¸­", "é«˜é›„", "å°å—", "å®œè˜­", "èŠ±è“®"] },
                { name: "æ—¥æœ¬", cities: ["æ±äº¬", "å¤§é˜ª", "äº¬éƒ½", "åŒ—æµ·é“", "æ²–ç¹©", "ç¦å²¡"] },
                { name: "éŸ“åœ‹", cities: ["é¦–çˆ¾", "é‡œå±±", "æ¿Ÿå·å³¶"] }
            ]},
            { continent: "æ±å—äº", icon: "ğŸï¸", countries: [
                { name: "æ³°åœ‹", cities: ["æ›¼è°·", "æ¸…é‚", "æ™®å‰å³¶"] },
                { name: "æ–°åŠ å¡", cities: ["æ–°åŠ å¡å¸‚"] },
                { name: "é¦¬ä¾†è¥¿äº", cities: ["å‰éš†å¡", "æª³åŸ"] }
            ]},
            { continent: "æ­æ´²", icon: "ğŸ°", countries: [
                { name: "è‹±åœ‹", cities: ["å€«æ•¦", "æ›¼å¾¹æ–¯ç‰¹"] },
                { name: "æ³•åœ‹", cities: ["å·´é»", "é¦¬è³½"] },
                { name: "ç¾©å¤§åˆ©", cities: ["ç¾…é¦¬", "å¨å°¼æ–¯"] }
            ]},
            { continent: "åŒ—ç¾æ´²", icon: "ğŸ—½", countries: [
                { name: "ç¾åœ‹", cities: ["ç´ç´„", "æ´›æ‰ç£¯", "æ‹‰æ–¯ç¶­åŠ æ–¯"] }
            ]}
        ];

        const rankingData = {
            "å°åŒ—": {
                country: "å°ç£",
                spot: [
                    {n:"å°åŒ— 101", s:"4.9", d:"æ›¾ç‚ºä¸–ç•Œç¬¬ä¸€é«˜æ¨“ï¼Œæ“æœ‰éœ‡æ’¼çš„è§€æ™¯å°ã€‚", l:"å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ", img:"https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800"},
                    {n:"åœ‹ç«‹æ•…å®®åšç‰©é™¢", s:"4.9", d:"æ”¶è—å…¨çƒæœ€è±å¯Œçš„ä¸­è¯è—è¡“ç‘°å¯¶ã€‚", l:"å°åŒ—å¸‚å£«æ—å€è‡³å–„è·¯äºŒæ®µ221è™Ÿ", img:"https://images.unsplash.com/photo-1552056123-28b02382746a?w=800"},
                    {n:"è±¡å±±è¦ªå±±æ­¥é“", s:"4.7", d:"æ‹æ”å°åŒ— 101 å…¨æ™¯çš„æœ€ä½³åœ°é»ã€‚", l:"å°åŒ—å¸‚ä¿¡ç¾©å€"},
                    {n:"è¥¿é–€ç”ºå•†åœˆ", s:"4.6", d:"å°åŒ—æµè¡Œæ–‡åŒ–çš„èšé»èˆ‡ç¾é£Ÿå¤©å ‚ã€‚", l:"å°åŒ—å¸‚è¬è¯å€"},
                    {n:"é¾å±±å¯º", s:"4.8", d:"æ­·å²æ‚ ä¹…ä¸”å»ºç¯‰ç²¾ç¾çš„å¤è€å»Ÿå®‡ã€‚", l:"å°åŒ—å¸‚è¬è¯å€å»£å·è¡—211è™Ÿ"},
                    {n:"å¤§ç¨»åŸ•", s:"4.7", d:"å……æ»¿æ‡·èˆŠæ°›åœçš„è€è¡—èˆ‡æ–‡å‰µç©ºé–“ã€‚", l:"å°åŒ—å¸‚å¤§åŒå€"},
                    {n:"ä¸­æ­£ç´€å¿µå ‚", s:"4.6", d:"å£¯éº—çš„ç™½ç‰†è—ç“¦å»ºç¯‰èˆ‡å»£å¤§å…¬åœ’ã€‚", l:"å°åŒ—å¸‚ä¸­æ­£å€"},
                    {n:"åŒ—æŠ•æº«æ³‰", s:"4.8", d:"ç¡«ç£ºç¹šç¹çš„åŸå¸‚æº«æ³‰ç§˜å¢ƒã€‚", l:"å°åŒ—å¸‚åŒ—æŠ•å€"},
                    {n:"å£«æ—å¤œå¸‚", s:"4.5", d:"èååœ‹éš›çš„å¤§å‹è§€å…‰å¤œå¸‚ã€‚", l:"å°åŒ—å¸‚å£«æ—å€"},
                    {n:"é™½æ˜å±±åœ‹å®¶å…¬åœ’", s:"4.9", d:"å››å­£åˆ†æ˜çš„ç«å±±åœ°è²Œè‡ªç„¶æ™¯è§€ã€‚", l:"å°åŒ—å¸‚åŒ—æŠ•å€"}
                ],
                food: [
                    {n:"é¼æ³°è± (ä¿¡ç¾©åº—)", s:"4.9", d:"é»ƒé‡‘æ¯”ä¾‹ 18 æ‘ºå°ç± åŒ…ç²¾å“ã€‚"},
                    {n:"é˜œæ­è±†æ¼¿", s:"4.7", d:"è¶…äººæ°£ç¶“å…¸ä¸­å¼æ’éšŠæ—©é¤ã€‚"},
                    {n:"å¯§å¤å¤œå¸‚ (å°åƒ)", s:"4.8", d:"å°åŒ—è€å­—è™Ÿç¾é£Ÿçš„åŒ¯é›†åœ°ã€‚"}
                ]
            },
            "æ±äº¬": {
                country: "æ—¥æœ¬",
                spot: [
                    {n:"æ·ºè‰å¯º", s:"4.9", d:"æ±äº¬éƒ½å…§æœ€å¤è€çš„å¯ºé™¢ï¼Œåœ°æ¨™é›·é–€å¿…æ‹ã€‚", l:"æ±äº¬éƒ½å°æ±å€æ·ºè‰2-3-1", img:"https://images.unsplash.com/photo-1545569341-9eb8b30979d9?w=800"},
                    {n:"æ±äº¬éµå¡”", s:"4.8", d:"è±¡å¾µæ±äº¬çš„ç²¾ç¥èˆ‡æ¥µè‡´å¤œæ™¯åœ°æ¨™ã€‚", l:"æ±äº¬éƒ½æ¸¯å€èŠå…¬åœ’", img:"https://images.unsplash.com/photo-1503899036084-c55cdd92da26?w=800"},
                    {n:"æ˜æ²»ç¥å®®", s:"4.7", d:"é¬§å€ä¸­çš„å¯§éœæ£®æ—ï¼ŒèŠåš´å£¯éº—ã€‚", l:"æ±äº¬éƒ½æ¾€è°·å€"},
                    {n:"æ¾€è°· Sky", s:"4.9", d:"å…¨æ–°å±•æœ›å°ï¼Œä¿¯ç°è‘—åçš„æ¾€è°·åå­—è·¯å£ã€‚"},
                    {n:"æ–°å®¿å¾¡è‹‘", s:"4.7", d:"çµåˆæ—¥å¼ã€è‹±å¼èˆ‡æ³•å¼é¢¨æ ¼çš„å»£å¤§åœ’æ—ã€‚"},
                    {n:"ä¸Šé‡æ©è³œå…¬åœ’", s:"4.6", d:"åšç‰©é¤¨èˆ‡ç¾è¡“é¤¨æ—ç«‹çš„æ–‡åŒ–æ ¸å¿ƒå€ã€‚"},
                    {n:"ç§‹è‘‰åŸé›»å™¨è¡—", s:"4.5", d:"äºŒæ¬¡å…ƒæ–‡åŒ–èˆ‡ç§‘æŠ€æ„›å¥½è€…çš„è–åœ°ã€‚"},
                    {n:"å…­æœ¬æœ¨ä¹‹ä¸˜", s:"4.7", d:"æ™‚å°šè—è¡“ä¸­å¿ƒï¼Œè§€æ™¯è¦–è§’æ¥µä½³ã€‚"},
                    {n:"ç¯‰åœ°å¤–å¸‚å ´", s:"4.8", d:"åœ¨åœ°æµ·é®®ç¾é£Ÿèˆ‡è·äººç²¾ç¥çš„é›†æ•£åœ°ã€‚"},
                    {n:"çš‡å±…", s:"4.6", d:"å¤©çš‡ä½æ‰€ï¼Œæ­·å²å¤å ¡èˆ‡è­·åŸæ²³æ™¯è‰²å„ªç¾ã€‚"}
                ]
            }
        };

        const init = async () => {
            // é¦–å…ˆå•Ÿå‹•å®šä½
            await detectLocation();

            if (isDemoMode) { render(); return; }
            try {
                const appInstance = initializeApp(config);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);
                const token = window['__initial_auth_token'];
                if (token) await signInWithCustomToken(auth, token);
                else await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) setupListeners();
                    render();
                });
            } catch (e) { isDemoMode = true; render(); }
        };

        // --- åœ°ç†å®šä½ç³»çµ± ---
        window.detectLocation = () => {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log("ä¸æ”¯æ´å®šä½");
                    resolve();
                } else {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // æ¨¡æ“¬ç°¡å–®ç¶“ç·¯åº¦æ¯”å°é‚è¼¯ (å¯¦å‹™ä¸Šæœƒæ¥ API)
                            // é€™è£¡ç›´æ¥ç¤ºç¯„æˆåŠŸå–å¾—ä½ç½®å¾Œçš„é è¨­æ›´æ–°
                            state.activeRegion = "å°åŒ—"; // é è¨­æ‰€åœ¨åœ°
                            state.activeCountry = "å°ç£";
                            render();
                            resolve();
                        },
                        (error) => {
                            console.log("å®šä½æ¬Šé™é­æ‹’æˆ–å¤±æ•—", error);
                            resolve();
                        },
                        { timeout: 5000 }
                    );
                }
            });
        };

        const setupListeners = () => {
            if (!currentUser || !db) return;
            const userRef = (col) => collection(db, 'artifacts', appId, 'users', currentUser.uid, col);
            const err = (e) => console.warn(e);
            onSnapshot(userRef('calories'), s => { state.calories = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='calorie') render(); }, err);
            onSnapshot(userRef('journals'), s => { state.journals = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='journal') render(); }, err);
            onSnapshot(userRef('itineraries'), s => { state.itineraries = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='itinerary') render(); }, err);
            onSnapshot(userRef('checklist'), s => { state.checklist = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='checklist') render(); }, err);
            onSnapshot(userRef('favorites'), s => { state.favorites = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='favorite' || activeTab==='home') render(); }, err);
            onSnapshot(userRef('folders'), s => { 
                const f = s.docs.map(d => d.data().name);
                state.folders = f.length > 0 ? f : ["é è¨­æ”¶è—"];
                if(activeTab==='favorite') render(); 
            }, err);
        };

        window.switchTab = (tab) => { activeTab = tab; state.selectedGuide = null; state.selectedSpot = null; render(); };
        window.render = () => {
            const main = document.getElementById('main-content');
            const mapBtn = document.getElementById('floating-map-btn');
            
            if (activeTab === 'home' && !state.selectedGuide && !state.selectedSpot) mapBtn.classList.remove('hidden');
            else mapBtn.classList.add('hidden');

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active', 'bg-[#8EC5FC]', 'bg-[#FF85A1]', 'bg-[#FFA45B]', 'bg-[#FFCCF9]', 'bg-[#FFD1A4]', 'bg-[#B2F9B4]', 'text-white', 'shadow-lg'));
            const activeBtn = document.getElementById(`nav-${activeTab}`);
            const themes = { home: 'bg-[#8EC5FC]', favorite: 'bg-[#FF85A1]', itinerary: 'bg-[#FFA45B]', calorie: 'bg-[#FFCCF9]', journal: 'bg-[#FFD1A4]', checklist: 'bg-[#B2F9B4]' };
            if (activeBtn) activeBtn.classList.add('nav-active', themes[activeTab], 'text-white', 'shadow-lg');

            if (state.selectedSpot) main.innerHTML = renderSpotDetail();
            else if (state.selectedGuide) main.innerHTML = renderGuideDetail();
            else {
                switch(activeTab) {
                    case 'home': main.innerHTML = renderHome(); break;
                    case 'favorite': main.innerHTML = renderFavorite(); break;
                    case 'itinerary': main.innerHTML = renderItinerary(); break;
                    case 'calorie': main.innerHTML = renderCalorie(); break;
                    case 'journal': main.innerHTML = renderJournal(); break;
                    case 'checklist': main.innerHTML = renderChecklist(); break;
                }
            }
            lucide.createIcons();
        };

        // --- è©³æƒ…é  ---
        const renderSpotDetail = () => {
            const s = state.selectedSpot;
            return `
                <div class="space-y-6 fade-in pb-10">
                    <button onclick="window.state.selectedSpot=null; render()" class="flex items-center gap-2 text-slate-400 font-bold hover:text-[#FF85A1] active:scale-95 transition-all">
                        <i data-lucide="arrow-left"></i> è¿”å›æ¸…å–®
                    </button>
                    <div class="bg-white rounded-[3rem] overflow-hidden shadow-xl border border-slate-50">
                        <div class="h-64 relative">
                            <img src="${s.img || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800'}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 spot-card-gradient"></div>
                            <div class="absolute bottom-6 left-8 text-white">
                                <span class="text-[9px] font-black uppercase tracking-widest bg-white/20 px-2 py-1 rounded-full border border-white/20">${state.activeCountry} | ${state.activeRegion}</span>
                                <h2 class="text-3xl font-black mt-2">${s.n}</h2>
                                <div class="flex items-center gap-1 mt-2 text-yellow-400"><i data-lucide="star" class="w-4 h-4 fill-current"></i><span class="font-bold text-white">${s.s} / 5.0</span></div>
                            </div>
                        </div>
                        <div class="p-8 space-y-6">
                            <section><h3 class="text-xs font-black text-slate-300 uppercase tracking-widest mb-3">äº®é»ä»‹ç´¹</h3><p class="text-slate-600 leading-relaxed font-medium text-sm">${s.d}</p></section>
                            <section class="bg-slate-50 p-6 rounded-3xl"><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">åœ°å€ä½ç½®</h3><div class="flex items-start gap-3"><i data-lucide="map-pin" class="w-5 h-5 text-[#8EC5FC] flex-shrink-0"></i><p class="text-slate-700 font-bold text-sm">${s.l || 'æ‰€åœ¨åŸå¸‚å€åŸŸå…§'}</p></div></section>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.n + ' ' + state.activeRegion)}')" class="bg-[#8EC5FC] text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 flex items-center justify-center gap-2"><i data-lucide="navigation" class="w-5 h-5"></i> å°èˆª</button>
                                <button onclick="toggleFav('${s.n}', '${s.img || ''}')" class="bg-[#FF85A1] text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 flex items-center justify-center gap-2"><i data-lucide="heart" class="w-5 h-5" ${state.favorites.some(f=>f.name===s.n)?'fill="white"':''}></i> æ”¶è—</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        // --- æ’è¡Œæ¦œ ---
        const renderGuideDetail = () => {
            const guide = state.selectedGuide;
            const data = rankingData[state.activeRegion] || { spot: [], food: [] };
            let items = guide.id === 'spot' ? data.spot : data.food;
            
            // è£œè¶³ 10 é …
            if (items.length < 10) {
                const dummyNames = guide.id === 'spot' ? ['è§€æ™¯å…¬åœ’', 'åœ°æ¨™å¤§æ¨“', 'ç‰¹è‰²è¡—é“', 'æ–‡åŒ–è—è¡“ä¸­å¿ƒ', 'ç¥ç§˜æ­¥é“', 'é€±æœ«å¸‚é›†', 'è§€æ™¯é¤å»³', 'å¸‚æ°‘å»£å ´', 'æ­·å²é™³åˆ—é¤¨', 'æ²³ç•”å…¬åœ’'] : ['å¿…åƒæ‹‰éºµ', 'é“åœ°ç‡’è‚‰', 'äººæ°£ç”œé»', 'å··å¼„å’–å•¡', 'æ·±å¤œå±…é…’å±‹', 'è·äººæ‰‹ä½œ', 'å‚³çµ±å°åƒ', 'æµ·é®®ååº—', 'å‰µæ„æ–™ç†', 'æ’éšŠæ—©é¤'];
                const fillerCount = items.length;
                for (let i = fillerCount; i < 10; i++) {
                    items.push({n: `${state.activeRegion}${dummyNames[i]}`, s: (4.9 - i * 0.1).toFixed(1), d: "é€™æ˜¯ç‚ºæ‚¨æ¨è–¦çš„å„ªè³ªæ—…éŠåœ°é»ï¼Œé»æ“ŠæŸ¥çœ‹è©³ç´°çš„åœ°ç†ä½ç½®èˆ‡ç²¾å½©ä»‹ç´¹ã€‚", l: `${state.activeRegion}å¸‚ä¸­å¿ƒç‰¹å®šå€`});
                }
            }

            return `
                <div class="space-y-6 fade-in pb-10">
                    <div class="flex justify-between items-center">
                        <button onclick="window.state.selectedGuide=null; render()" class="flex items-center gap-2 text-slate-400 font-bold hover:text-[#FF85A1] active:scale-95 transition-all"><i data-lucide="arrow-left"></i> è¿”å›</button>
                        <button onclick="openRegionPicker()" class="px-4 py-2 bg-white border border-slate-100 rounded-full text-xs font-black text-[#FF85A1] shadow-sm flex items-center gap-1 active:scale-95 transition-all"><i data-lucide="map-pin" class="w-3 h-3"></i> ${state.activeCountry} | ${state.activeRegion}</button>
                    </div>
                    <div class="${guide.color} p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                        <h2 class="text-3xl font-black">${guide.title}</h2>
                        <div class="absolute top-4 right-4 text-7xl opacity-20 transform rotate-12">${guide.img}</div>
                    </div>
                    <div class="space-y-3">
                        ${items.map((it, idx) => `
                            <div onclick="window.state.selectedSpot=${JSON.stringify(it).replace(/"/g, '&quot;')}; render()" class="bg-white p-5 rounded-[2.2rem] shadow-sm border border-slate-50 flex items-center gap-5 cursor-pointer hover:bg-slate-50 active:scale-95 transition-all group">
                                <div class="w-12 h-12 ${idx<3?'bg-yellow-400':'bg-slate-100'} rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-inner">${idx+1}</div>
                                <div class="flex-1"><h4 class="font-black text-slate-700 leading-tight">${it.n}</h4><p class="text-[10px] text-slate-300 font-bold mt-1 uppercase">é»æ“ŠæŸ¥çœ‹è©³é«”</p></div>
                                <div class="text-[#FF85A1] font-black text-2xl group-hover:translate-x-1 transition-transform">${it.s}</div>
                            </div>`).join('')}
                    </div>
                </div>`;
        };

        const renderHome = () => {
            const data = rankingData[state.activeRegion] || { spot: [], food: [] };
            const localRecs = data.spot.slice(0, 3);
            const displayRecs = localRecs.length > 0 ? localRecs.map(x => ({...x, r: state.activeRegion, c: state.activeCountry})) : [
                {n:'äº¬éƒ½æ¸…æ°´å¯º', r:'äº¬éƒ½', c:'æ—¥æœ¬', d:'äº¬éƒ½æœ€å¤è€çš„å¯ºé™¢ï¼Œèˆå°å£¯è§€ã€‚', img:'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400', t:'æ­·å²'},
                {n:'æ›¼è°·å¤§çš‡å®®', r:'æ›¼è°·', c:'æ³°åœ‹', d:'æ³°åœ‹æœ€å…·è¦æ¨¡çš„ç‹å®¤å»ºç¯‰ç¾¤ã€‚', img:'https://images.unsplash.com/photo-1510379872535-9310dc6fd6a7?w=400', t:'å»ºç¯‰'},
                {n:'ç´ç´„è‡ªç”±å¥³ç¥', r:'ç´ç´„', c:'ç¾åœ‹', d:'ç¾åœ‹æœ€çŸ¥åçš„ç²¾ç¥è±¡å¾µã€‚', img:'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=400', t:'åœ°æ¨™'}
            ];

            return `
                <div class="space-y-8 fade-in">
                    <section>
                        <div class="flex justify-between items-end mb-4 px-1">
                            <h3 class="text-xl font-black flex items-center gap-2"><div class="w-2 h-6 bg-[#FF85A1] rounded-full"></div>${state.activeCountry} | ä»Šæ—¥æ¨è–¦</h3>
                            <button onclick="openRegionPicker()" class="text-xs font-black text-[#FF85A1] active:scale-95 transition-all">æ›´æ›åœ°å€ â–¾</button>
                        </div>
                        <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar -mx-5 px-5 snap-x">
                            ${displayRecs.map(s => `
                                <div onclick="window.state.selectedSpot=${JSON.stringify(s).replace(/"/g, '&quot;')}; state.activeRegion='${s.r}'; state.activeCountry='${s.c || 'å°ç£'}'; render()" class="min-w-[200px] h-64 relative rounded-[2.5rem] overflow-hidden shadow-lg snap-start cursor-pointer group active:scale-95 transition-all">
                                    <img src="${s.img || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=400'}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                                    <button onclick="event.stopPropagation(); toggleFav('${s.n}', '${s.img || ''}')" class="absolute top-4 right-4 p-2 bg-white/20 backdrop-blur-md rounded-full text-white active:scale-90 z-20 transition-all">
                                        <i data-lucide="heart" class="w-4 h-4" ${state.favorites.some(f=>f.name===s.n)?'fill="white"':''}></i>
                                    </button>
                                    <div class="absolute bottom-6 left-6 text-white">
                                        <span class="text-[9px] bg-white/20 backdrop-blur-md px-2.5 py-1 rounded-full uppercase font-bold border border-white/20">${s.t || 'æ¨è–¦'}</span>
                                        <p class="text-lg font-black mt-2 leading-tight">${s.n}</p>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </section>

                    <section class="space-y-4">
                        <h3 class="text-xl font-black px-1">${state.activeRegion} å°ˆå±¬æ’è¡Œæ¦œ</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div onclick="openGuide({id:'spot', title:'ç†±é–€æ™¯é»æ’è¡Œ', color:'bg-[#8EC5FC]', img:'ğŸ¯'})" class="bg-white p-6 rounded-[2rem] shadow-sm flex items-center gap-5 cursor-pointer hover:shadow-md border border-slate-50 active:scale-95 transition-all">
                                <div class="w-16 h-16 bg-[#8EC5FC] rounded-2xl flex items-center justify-center text-3xl shadow-inner">ğŸ¯</div>
                                <div class="flex-1"><span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">åœ°æ¨™</span><h4 class="font-black text-lg text-slate-700 leading-tight">æ™¯é»æ’è¡Œ</h4></div>
                                <i data-lucide="chevron-right" class="text-slate-200"></i>
                            </div>
                            <div onclick="openGuide({id:'food', title:'å¿…åƒç¾é£Ÿåœ°åœ–', color:'bg-[#FFCCF9]', img:'ğŸ£'})" class="bg-white p-6 rounded-[2rem] shadow-sm flex items-center gap-5 cursor-pointer hover:shadow-md border border-slate-50 active:scale-95 transition-all">
                                <div class="w-16 h-16 bg-[#FFCCF9] rounded-2xl flex items-center justify-center text-3xl shadow-inner">ğŸ£</div>
                                <div class="flex-1"><span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">åœ¨åœ°</span><h4 class="font-black text-lg text-slate-700 leading-tight">ç¾é£Ÿæ¨è–¦</h4></div>
                                <i data-lucide="chevron-right" class="text-slate-200"></i>
                            </div>
                        </div>
                    </section>
                </div>`;
        };

        const renderFavorite = () => `
            <div class="space-y-6 fade-in">
                <div class="flex justify-between items-center"><h3 class="text-2xl font-black text-[#FF85A1]">æˆ‘çš„æ”¶è— â¤ï¸</h3>
                    <div class="flex gap-2"><button onclick="addFolder()" class="bg-[#FF85A1] text-white p-2.5 rounded-xl shadow-md active:scale-90"><i data-lucide="folder-plus" class="w-5 h-5"></i></button></div>
                </div>
                <div class="flex gap-3 overflow-x-auto no-scrollbar py-2 px-1">
                    ${state.folders.map(f => `<div class="relative flex-shrink-0 group"><button onclick="window.state.activeFolder='${f}'; render()" class="px-6 py-3 rounded-2xl font-black whitespace-nowrap text-sm transition-all ${state.activeFolder===f ? 'folder-active':'bg-white text-slate-400 border border-slate-100'}">${f}</button>${f !== "é è¨­æ”¶è—" ? `<button onclick="deleteFolder('${f}')" class="absolute -top-1 -right-1 bg-red-400 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}</div>`).join('')}
                </div>
                <div class="grid grid-cols-2 gap-4 pb-10">
                    ${state.favorites.filter(f=> (f.folder || "é è¨­æ”¶è—") === state.activeFolder).map(f => `<div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-slate-50 relative group"><img src="${f.img || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=400'}" class="w-full h-36 object-cover group-hover:scale-110 transition-transform"><div class="p-4"><h4 class="font-black text-slate-700 text-sm truncate">${f.name}</h4><div class="flex justify-between items-center mt-2"><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(f.name)}')" class="text-[10px] font-bold text-[#8EC5FC]">å°èˆª</button><button onclick="deleteDocById('favorites', '${f.id}')" class="text-slate-300 hover:text-red-400 active:scale-90"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>`).join('') || `<div class="col-span-2 py-20 text-center text-slate-300 font-bold italic">å°šç„¡ä»»ä½•æ”¶è—é …ç›®</div>`}
                </div>
            </div>`;

        // --- å…¨åŸŸåŠŸèƒ½å‡½æ•¸ ---
        window.openGuide = (g) => { state.selectedGuide = g; render(); };
        window.addFolder = async () => {
            const n = prompt("è³‡æ–™å¤¾åç¨±ï¼š"); if (!n) return;
            if (isDemoMode) { state.folders.push(n); state.activeFolder = n; render(); }
            else { await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'folders'), { name: n, time: Date.now() }); }
        };
        window.deleteFolder = async (name) => {
            if (name === "é è¨­æ”¶è—") return;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€åŠå…¶æ”¶è—å—ï¼Ÿ`)) return;
            if (isDemoMode) { state.folders = state.folders.filter(x => x !== name); render(); }
            else { try {
                const ds = await getDocs(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'folders'));
                const did = ds.docs.find(d => d.data().name === name)?.id;
                if (did) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'folders', did));
            } catch(e) {} }
            state.activeFolder = "é è¨­æ”¶è—";
        };
        window.addCal = async () => {
            const n = document.getElementById('cal-name').value; const v = document.getElementById('cal-val').value;
            if(!n || !v) return;
            if (isDemoMode) { state.calories.push({id:Date.now().toString(), name:n, cal:parseInt(v)}); render(); }
            else { await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'calories'), { name:n, cal:parseInt(v), time:Date.now() }); }
            document.getElementById('cal-name').value = ''; document.getElementById('cal-val').value = '';
        };
        window.addJou = async () => {
            const t = document.getElementById('jou-text').value; if(!t) return;
            if (isDemoMode) { state.journals.push({id:Date.now().toString(), content:t, date:new Date().toLocaleDateString(), time:Date.now()}); render(); }
            else { await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals'), { content:t, date:new Date().toLocaleDateString(), time:Date.now() }); }
            document.getElementById('jou-text').value = '';
        };
        window.addItin = async () => {
            const t = prompt("è¡Œç¨‹æ¨™é¡Œï¼š"); if(!t) return;
            if (isDemoMode) { state.itineraries.push({id:Date.now().toString(), title:t, type:state.activeItinTab, date:new Date().toLocaleDateString()}); render(); }
            else { await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries'), { title:t, type:state.activeItinTab, date:new Date().toLocaleDateString() }); }
        };
        window.addCheck = async () => {
            const i = document.getElementById('check-item').value; if(!i) return;
            if (isDemoMode) { state.checklist.push({id:Date.now().toString(), item:i, done:false}); render(); }
            else { await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'checklist'), { item:i, done:false, time:Date.now() }); }
            document.getElementById('check-item').value = '';
        };
        window.toggleCheck = async (id, s) => { 
            if (isDemoMode) { const item = state.checklist.find(x => x.id === id); if(item) item.done = !s; render(); }
            else { await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'checklist', id), { done: !s }); }
        };
        window.toggleFav = async (n, img) => {
            const ex = state.favorites.find(f => f.name === n);
            if (isDemoMode) { if(ex) state.favorites = state.favorites.filter(f => f.name !== n); else state.favorites.push({id:Date.now().toString(), name:n, img, folder:state.activeFolder}); render(); }
            else {
                if(ex) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'favorites', ex.id));
                else await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'favorites'), { name:n, img, folder:state.activeFolder, time:Date.now() });
            }
        };
        window.deleteDocById = async (col, id) => { 
            if (isDemoMode) { state[col] = state[col].filter(x => x.id !== id); render(); }
            else { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, col, id)); }
        };

        // --- é¸å–å™¨é‚è¼¯ ---
        window.openRegionPicker = () => {
            const m = document.getElementById('region-picker');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.add('opacity-100'); m.querySelector('div').classList.remove('translate-y-full'); }, 10);
            state.pickerStep = 'continent'; state.searchQuery = '';
            document.getElementById('picker-search').value = '';
            renderPickerContent();
        };
        window.closePicker = () => {
            const m = document.getElementById('region-picker');
            m.classList.remove('opacity-100'); m.querySelector('div').classList.add('translate-y-full');
            setTimeout(() => m.classList.add('hidden'), 500);
        };
        window.handlePickerSearch = (val) => { state.searchQuery = val.trim(); state.pickerStep = state.searchQuery ? 'search' : 'continent'; renderPickerContent(); };
        window.selectContinent = (c) => { state.selectedContinent = c; state.pickerStep = 'country'; renderPickerContent(); };
        window.selectCountry = (c) => { state.selectedCountry = c; state.pickerStep = 'city'; renderPickerContent(); };
        window.selectCity = (c) => { 
            state.activeRegion = c; 
            state.activeCountry = state.selectedCountry || (geoData.find(cont => cont.countries.some(count => count.cities.includes(c)))?.countries.find(count => count.cities.includes(c))?.name) || 'å°ç£';
            closePicker(); 
            render(); 
        };

        const renderPickerContent = () => {
            const container = document.getElementById('picker-content');
            let html = "";
            if (state.pickerStep === 'search') {
                const results = [];
                geoData.forEach(cont => cont.countries.forEach(count => count.cities.forEach(city => {
                    if (city.includes(state.searchQuery) || count.name.includes(state.searchQuery)) results.push({ city, country: count.name, icon: cont.icon });
                })));
                html = `<div class="space-y-2">${results.map(r => `<button onclick="state.selectedCountry='${r.country}'; selectCity('${r.city}')" class="w-full bg-slate-50 p-4 rounded-2xl flex items-center justify-between hover:bg-[#FF85A1]/10 transition-all"><span class="font-bold text-slate-600">${r.icon} ${r.city}</span><span class="text-[10px] text-slate-400 font-black">${r.country}</span></button>`).join('') || '<p class="py-10 text-center text-slate-300 italic">æŸ¥ç„¡åŸå¸‚</p>'}</div>`;
            } else if (state.pickerStep === 'continent') {
                html = `<div class="grid grid-cols-2 gap-4">${geoData.map(c => `<button onclick="selectContinent('${c.continent}')" class="bg-slate-50 p-6 rounded-3xl flex flex-col items-center gap-3 border-2 border-transparent hover:border-[#FF85A1]/30 transition-all"><span class="text-4xl">${c.icon}</span><span class="font-black text-slate-600 text-sm tracking-widest">${c.continent}</span></button>`).join('')}</div>`;
            } else if (state.pickerStep === 'country') {
                const countries = geoData.find(d => d.continent === state.selectedContinent).countries;
                html = `<div class="space-y-2"><button onclick="state.pickerStep='continent'; renderPickerContent()" class="text-xs font-black text-[#FF85A1] mb-3 px-2 flex items-center gap-1 active:scale-95 transition-all"><i data-lucide="chevron-left" class="w-3 h-3"></i> è¿”å›å„å¤§æ´²</button>${countries.map(c => `<button onclick="selectCountry('${c.name}')" class="w-full bg-slate-50 p-5 rounded-2xl flex items-center justify-between font-black text-slate-600 hover:bg-slate-100 transition-all"><span>${c.name}</span><i data-lucide="chevron-right" class="w-4 h-4 text-slate-200"></i></button>`).join('')}</div>`;
            } else if (state.pickerStep === 'city') {
                const cities = geoData.find(d => d.continent === state.selectedContinent).countries.find(c => c.name === state.selectedCountry).cities;
                html = `<div class="space-y-2"><button onclick="state.pickerStep='country'; renderPickerContent()" class="text-xs font-black text-[#FF85A1] mb-3 px-2 flex items-center gap-1 active:scale-95 transition-all"><i data-lucide="chevron-left" class="w-3 h-3"></i> è¿”å›${state.selectedCountry}</button><div class="grid grid-cols-2 gap-3">${cities.map(c => `<button onclick="selectCity('${c}')" class="bg-[#FF85A1]/5 border-2 border-[#FF85A1]/10 p-5 rounded-3xl font-black text-[#FF85A1] text-sm active:scale-95 transition-all">${c}</button>`).join('')}</div></div>`;
            }
            container.innerHTML = html; lucide.createIcons();
        };

        const renderItinerary = () => `
            <div class="space-y-6 fade-in pb-10">
                <div class="flex justify-between items-center"><h3 class="text-2xl font-black text-[#FFA45B]">è¡Œç¨‹è¨ˆç•« ğŸ—ºï¸</h3><button onclick="addItin()" class="w-12 h-12 bg-[#FFA45B] text-white rounded-2xl shadow-lg flex items-center justify-center active:scale-90 transition-all"><i data-lucide="plus"></i></button></div>
                <div class="bg-white p-1.5 rounded-[1.8rem] flex shadow-inner border border-slate-100"><button onclick="window.state.activeItinTab='personal'; render()" class="flex-1 py-3 rounded-[1.5rem] font-black text-sm transition-all ${state.activeItinTab==='personal'?'bg-[#FFA45B] text-white shadow-md':'text-slate-400'}">å€‹äºº</button><button onclick="window.state.activeItinTab='shared'; render()" class="flex-1 py-3 rounded-[1.5rem] font-black text-sm transition-all ${state.activeItinTab==='shared'?'bg-[#FF85A1] text-white shadow-md':'text-slate-400'}">å…±äº«</button></div>
                <div class="space-y-4">
                    ${state.itineraries.filter(i => (i.type || 'personal') === state.activeItinTab).map(i => `<div class="bg-white p-5 rounded-[2.2rem] shadow-sm flex items-center gap-5 border border-slate-50 active:scale-98 transition-transform"><div class="w-14 h-14 rounded-2xl bg-slate-50 flex items-center justify-center text-2xl">${state.activeItinTab==='personal'?'ğŸ“Œ':'ğŸ¤'}</div><div class="flex-1"><h4 class="font-black text-slate-700 text-lg leading-tight">${i.title}</h4><p class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-tighter">${i.date}</p></div><button onclick="deleteDocById('itineraries', '${i.id}')" class="text-slate-200 hover:text-red-400 p-2 active:scale-90"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('') || `<p class="py-20 text-center text-slate-300 font-bold italic">ç›®å‰ç„¡è¡Œç¨‹è¨ˆç•«</p>`}
                </div>
            </div>`;

        const renderCalorie = () => {
            const total = state.calories.reduce((sum, i) => sum + i.cal, 0);
            return `
            <div class="space-y-6 fade-in pb-10">
                <div class="bg-[#FFCCF9] p-10 rounded-[3rem] text-center shadow-xl relative overflow-hidden"><div class="relative z-10"><p class="text-[#FF85A1] font-black text-xs tracking-widest uppercase mb-1">ä»Šæ—¥ç¾é£Ÿé ç®—</p><div class="text-6xl font-black text-white drop-shadow-md">${total} <span class="text-xl">kcal</span></div></div><i data-lucide="flame" class="absolute -bottom-10 -left-10 w-48 h-48 text-white opacity-25"></i></div>
                <div class="bg-white p-7 rounded-[2.5rem] space-y-4 border border-slate-50 shadow-sm"><div class="flex flex-col sm:flex-row gap-3"><input id="cal-name" class="flex-1 bg-slate-50 p-4 rounded-2xl text-sm border-2 border-transparent focus:border-[#FFCCF9]/50 outline-none" placeholder="åƒäº†ä»€éº¼ï¼Ÿ"><input id="cal-val" class="sm:w-28 bg-slate-50 p-4 rounded-2xl text-sm border-2 border-transparent focus:border-[#FFCCF9]/50 outline-none" placeholder="kcal" type="number"></div><button onclick="addCal()" class="w-full bg-[#FF85A1] text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">è¨˜éŒ„ç¾å‘³ ğŸ±</button></div>
                <div class="space-y-3">${state.calories.map(c => `<div class="bg-white/80 p-4 rounded-2xl flex justify-between items-center border border-white shadow-sm scale-in"><span class="font-bold text-slate-600">${c.name}</span><div class="flex items-center gap-4"><span class="text-[#FF85A1] font-black">${c.cal} kcal</span><button onclick="deleteDocById('calories', '${c.id}')" class="text-slate-300 hover:text-red-400 active:scale-90"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('')}</div>
            </div>`;
        };

        const renderJournal = () => `
            <div class="space-y-6 fade-in pb-10">
                <h3 class="text-2xl font-black text-[#FFD1A4]">å¿ƒæƒ…æ—¥è¨˜ âœï¸</h3>
                <div class="bg-white p-6 rounded-[2.5rem] space-y-4 border border-slate-50 shadow-sm"><textarea id="jou-text" class="w-full min-h-[160px] bg-slate-50 p-5 rounded-3xl outline-none text-slate-600 border-2 border-transparent focus:border-[#FFD1A4]/50" placeholder="åˆ†äº«ä»Šå¤©çš„é©šå–œ..."></textarea><button onclick="addJou()" class="w-full bg-[#FFD1A4] text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">å°å­˜ä»Šæ—¥ âœ¨</button></div>
                <div class="space-y-4">${state.journals.sort((a,b) => b.time - a.time).map(j => `<div class="bg-white p-6 rounded-[2.5rem] shadow-sm relative group border border-slate-50 scale-in"><div class="flex justify-between items-center mb-3"><p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">${j.date}</p><button onclick="deleteDocById('journals', '${j.id}')" class="text-slate-200 hover:text-red-400 transition-colors active:scale-90"><i data-lucide="trash" class="w-4 h-4"></i></button></div><p class="text-slate-600 text-sm font-medium leading-relaxed">${j.content}</p></div>`).join('')}</div>
            </div>`;

        const renderChecklist = () => `
            <div class="space-y-6 fade-in pb-10">
                <h3 class="text-2xl font-black text-[#56D8D0]">è¡Œææ¸…å–® âœ…</h3>
                <div class="bg-white p-5 rounded-[2.2rem] shadow-sm flex gap-3 border border-slate-50"><input id="check-item" class="flex-1 bg-slate-50 p-4 rounded-2xl text-sm border-2 border-transparent focus:border-[#56D8D0]/50 outline-none" placeholder="æº–å‚™å¸¶ä»€éº¼ï¼Ÿ"><button onclick="addCheck()" class="w-14 h-14 bg-[#56D8D0] text-white rounded-2xl flex items-center shadow-md active:scale-90 transition-all"><i data-lucide="plus"></i></button></div>
                <div class="space-y-3">${state.checklist.map(i => `<div class="bg-white p-5 rounded-3xl flex items-center gap-4 shadow-sm border border-slate-50 ${i.done ? 'opacity-50' : ''} scale-in"><button onclick="toggleCheck('${i.id}', ${i.done})" class="w-7 h-7 rounded-full border-2 border-[#56D8D0] flex items-center justify-center ${i.done ? 'bg-[#56D8D0] text-white' : ''}">${i.done ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</button><span class="flex-1 font-bold ${i.done ? 'line-through text-slate-400' : 'text-slate-600'}">${i.item}</span><button onclick="deleteDocById('checklist', '${i.id}')" class="text-slate-200 active:scale-90 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('')}</div>
            </div>`;

        window.onload = init;
    </script>
</body>
</html>